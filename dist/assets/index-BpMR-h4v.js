(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))e(l);new MutationObserver(l=>{for(const a of l)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function i(l){const a={};return l.integrity&&(a.integrity=l.integrity),l.referrerPolicy&&(a.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?a.credentials="include":l.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(l){if(l.ep)return;l.ep=!0;const a=i(l);fetch(l.href,a)}})();const nt=new URLSearchParams(location.search).get("debug")==="1",h=document.getElementById("game"),t=h.getContext("2d"),w=document.getElementById("mv"),k=document.getElementById("song");w.style.opacity="0";w.style.display="none";w.style.transition="opacity 1s ease";let c=window.innerWidth,u=window.innerHeight;h.width=c;h.height=u;window.addEventListener("resize",()=>{c=window.innerWidth,u=window.innerHeight,h.width=c,h.height=u});const ot=/iPhone|iPad|Android/i.test(navigator.userAgent),K=ot?.1:.045,T=document.createElement("div");T.style.cssText=`
  position:fixed;
  top:0; left:0;
  width:100vw; height:100vh;
  background:black;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:white;
  font-family:Arial Black, sans-serif;
  font-size:32px;
  z-index:99999;
`;T.innerHTML=`
  <div style="opacity:0.9">PROJECT BAGUETTE</div>
  <div id="tapText" style="margin-top:20px; font-size:20px; opacity:0.7;">Tap to Start</div>
`;document.body.appendChild(T);let O=!0;setInterval(()=>{O=!O;const n=document.getElementById("tapText");n&&(n.style.opacity=O?"0.9":"0.4")},600);let $=120;const N=60/$;let G=1.4+240/$,X=G;const it=.08,V=.18,lt=8,at=.2,D=.4,R=.6,rt=220,st=10,ct=14;let I=1,y=null,B=null,b=[],Y=!1,P=0;const p=[{key:"w",label:"W",color:"#FFD447"},{key:"a",label:"A",color:"#47FFA3"},{key:"s",label:"S",color:"#FF69B4"},{key:"d",label:"D",color:"#6AB4FF"}];function v(){return k&&!isNaN(k.currentTime)?k.currentTime:0}async function ft(){const n=window.AudioContext||window.webkitAudioContext;y||(y=new n);const o=y.createMediaElementSource(k);B=y.createAnalyser(),B.fftSize=2048,o.connect(B),B.connect(y.destination);try{const e=await(await fetch(k.src)).arrayBuffer(),l=await y.decodeAudioData(e),a=l.getChannelData(0),r=l.sampleRate,s=1024,g=512,f=[];for(let d=0;d+s<a.length;d+=g){let A=0;for(let S=0;S<s;S++)A+=a[d+S]**2;f.push(Math.sqrt(A/s))}let x=f.reduce((d,A)=>d+A,0)/f.length*1.25,E=-999;const C=.23;for(let d=1;d<f.length-1;d++){const A=f[d];if(A>x&&A>f[d-1]&&A>f[d+1]){const S=d*g/r;S-E>=C&&(b.push(S),E=S)}}if(b.length<4){console.warn("Sparse auto-chart → fallback");for(let d=0;d<l.duration;d+=.5)b.push(d)}Y=!0}catch(i){console.error("Auto-chart decode fail:",i);for(let e=0;e<120;e+=.5)b.push(e);Y=!0}}let m=[],F=[],U=0,L=0,_="",W=0;function dt(n,o,i){for(let e=0;e<14;e++)F.push({x:n,y:o,vx:(Math.random()-.5)*240,vy:(Math.random()-.5)*240,life:.4,color:i})}function j(n,o,i){return n+(o-n)*i}function ht(n,o){const i=c*.15,e=u*.15,l=i+Math.random()*(c-i*2),a=e+Math.random()*(u-e*2),r=c/2,s=u/2,g=l-r,f=a-s,M=Math.hypot(g,f)||1,x=g/M,E=f/M,C=Math.max(c,u)*.45;m.push({lane:n,time:o,spawnX:l-x*C,spawnY:a-E*C,targetX:l,targetY:a,judged:!1,effect:"none",effectTime:0,shakeSeed:Math.random()*Math.PI*2})}function ut(n){if(Y)for(;P<b.length&&b[P]<n+lt&&!(m.filter(o=>!o.judged).length>=4);)ht(Math.floor(Math.random()*p.length),b[P]),P++}const H=new Set;window.addEventListener("keydown",n=>{const o=n.key.toLowerCase();H.has(o)||(H.add(o),gt(o))});window.addEventListener("keyup",n=>H.delete(n.key.toLowerCase()));function gt(n){const o=p.findIndex(a=>a.key===n);if(o===-1)return;const i=v();let e=null,l=1/0;for(const a of m)if(!a.judged&&a.lane===o){const r=Math.abs(a.time-i);r<l&&(l=r,e=a)}e&&Q(e,i)}h.addEventListener("mousedown",n=>{const o=h.getBoundingClientRect();J((n.clientX-o.left)*(h.width/o.width),(n.clientY-o.top)*(h.height/o.height))});h.addEventListener("touchstart",n=>{const o=h.getBoundingClientRect(),i=n.touches[0];J((i.clientX-o.left)*(h.width/o.width),(i.clientY-o.top)*(h.height/o.height)),n.preventDefault()},{passive:!1});function J(n,o){const i=v(),e=Math.min(c,u)*K;let l=null,a=1/0;for(const r of m){if(r.judged)continue;const s=n-r.targetX,g=o-r.targetY,f=Math.hypot(s,g);if(f>e*1.2)continue;const x=Math.abs(r.time-i)+f/1e3;x<a&&(a=x,l=r)}l&&Q(l,i)}function Q(n,o){const i=Math.abs(n.time-o);i<=it?q(n,"COOL",300):i<=V?q(n,"FINE",100):i<=.35&&Z(n)}function q(n,o,i){n.judged=!0,n.effect="hit",n.effectTime=v(),L++,U+=Math.floor(i*(1+L*.05)),_=o,W=v(),dt(n.targetX,n.targetY,p[n.lane].color)}function Z(n){n.judged=!0,n.effect="miss",n.effectTime=v(),L=0,_="MISS",W=v()}let tt=0,z=performance.now();function pt(n){t.clearRect(0,0,c,u);const o=n%N/N;I=.5+.5*Math.sin(o*Math.PI*2),t.fillStyle="rgba(0,0,0,0.22)",t.fillRect(0,0,c,u);const i=Math.min(c,u)*K;for(const e of m)t.save(),t.globalAlpha=.18+I*.22,t.strokeStyle=p[e.lane].color,t.lineWidth=3,t.beginPath(),t.arc(e.targetX,e.targetY,i*.9,0,Math.PI*2),t.stroke(),t.globalAlpha=.05+.1*I,t.lineWidth=1.5,t.beginPath(),t.arc(e.targetX,e.targetY,i*(.7+.3*I),0,Math.PI*2),t.stroke(),t.restore();for(const e of m){const a=1-(e.time-n)/X;if(e.judged){const r=n-e.effectTime;if(e.effect==="hit"&&r<=D){t.save();const s=r/D;t.globalAlpha=1-s,t.fillStyle=p[e.lane].color,t.beginPath(),t.arc(e.targetX,e.targetY,i*(1+s*2.2),0,Math.PI*2),t.fill(),t.restore()}else if(e.effect==="miss"&&r<=R){const s=Math.sin(r*ct*Math.PI*2+e.shakeSeed)*st;t.globalAlpha=1-r/R,t.save(),t.fillStyle="rgba(255,255,255,0.9)",t.strokeStyle=p[e.lane].color,t.lineWidth=6,t.beginPath(),t.arc(e.targetX+s,e.targetY+r*rt,i,0,Math.PI*2),t.fill(),t.stroke(),t.restore(),t.globalAlpha=1}}else{if(a<0||a>1.5)continue;const r=j(e.spawnX,e.targetX,a),s=j(e.spawnY,e.targetY,a),g=e.targetX-e.spawnX,f=e.targetY-e.spawnY,M=Math.hypot(g,f)||1,x=g/M,E=f/M;t.save(),t.globalAlpha=.25+.15*I,t.strokeStyle=p[e.lane].color,t.lineWidth=10,t.lineCap="round",t.beginPath(),t.moveTo(r-x*130,s-E*130),t.lineTo(r,s),t.stroke(),t.restore(),t.save(),t.fillStyle="rgba(255,255,255,0.9)",t.strokeStyle=p[e.lane].color,t.lineWidth=6,t.beginPath(),t.arc(r,s,i,0,Math.PI*2),t.fill(),t.stroke(),t.fillStyle=p[e.lane].color,t.font=`${i*1.2}px Arial Black`,t.textAlign="center",t.textBaseline="middle",t.fillText(p[e.lane].label,r,s+i*.05),t.restore()}}for(let e of F)e.life-=1/60,e.x+=e.vx/60,e.y+=e.vy/60,t.globalAlpha=Math.max(0,e.life/.4)*(.5+.5*I),t.fillStyle=e.color,t.fillRect(e.x,e.y,4,4);F=F.filter(e=>e.life>0),t.globalAlpha=1,t.fillStyle="#fff",t.font="18px Arial",t.textAlign="left",t.fillText("Project Baguette",20,30),t.fillText("Score: "+U,20,55),t.fillText("Combo: "+L,20,80),n-W<.5&&_&&(t.font="32px Arial Black",t.textAlign="center",t.fillText(_,c/2,u*.2)),nt&&(t.fillStyle="rgba(0,0,0,0.6)",t.fillRect(c-200,10,180,100),t.fillStyle="#0f0",t.font="14px monospace",t.textAlign="left",t.fillText(`FPS: ${tt.toFixed(1)}`,c-190,30),t.fillText(`Time: ${n.toFixed(3)}s`,c-190,50),t.fillText(`Beats: ${b.length}`,c-190,70),t.fillText(`Idx: ${P}`,c-190,90))}function et(){const n=performance.now();tt=1e3/(n-z),z=n;const o=v(),i=m.filter(e=>!e.judged).length;X=j(X,G+i*.12,.18),ut(o),pt(o);for(const e of m)!e.judged&&o>e.time+V+at&&Z(e);m=m.filter(e=>{if(!e.judged)return!0;const l=o-e.effectTime;return e.effect==="hit"?l<=D:e.effect==="miss"?l<=R:!1}),requestAnimationFrame(et)}T.addEventListener("click",async()=>{T.style.transition="opacity 0.4s ease",T.style.opacity="0",setTimeout(()=>T.remove(),450);const n=window.AudioContext||window.webkitAudioContext;if(y||(y=new n),y.state==="suspended")try{await y.resume()}catch{}try{await ft()}catch(i){console.warn("Auto-chart early fail:",i)}try{await k.play()}catch{alert("Tap again — Safari blocked audio.");return}const o=()=>{w.style.display="block",requestAnimationFrame(()=>{w.style.opacity="1"});try{w.currentTime=0;const i=w.play();i&&i.catch&&i.catch(e=>console.warn("MV play blocked:",e))}catch(i){console.warn("MV play() error:",i)}};w.readyState>=2?o():w.addEventListener("loadeddata",o,{once:!0}),requestAnimationFrame(et)});
